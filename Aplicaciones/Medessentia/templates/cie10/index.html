{% extends "tu_app/base.html" %}
{% block title %}CIE-10{% endblock %}
{% block content %}
<div class="bg-white p-3 shadow-sm rounded-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 mb-0">Catálogo CIE-10</h1>
    <div class="d-flex gap-2">
      <input id="cie10_q" class="form-control form-control-sm" placeholder="Buscar código o descripción">
      <button class="btn btn-sm btn-outline-secondary" onclick="cie10_recargar()">Buscar</button>
      <button class="btn btn-primary" onclick="cie10_abrir()">Nuevo</button>
    </div>
  </div>
  <div class="table-responsive">
    <table id="cie10_tbl" class="table table-striped table-bordered w-100">
      <thead>
        <tr><th>ID</th><th>Código</th><th>Descripción</th><th>Acciones</th></tr>
      </thead><tbody></tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="cie10_md" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">CIE-10 - Formulario</h5>
      <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button></div>
    <div class="modal-body" id="cie10_md_body">Cargando...</div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      <button class="btn btn-primary" onclick="cie10_guardar()">Guardar</button>
    </div>
  </div></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let cie10_dt;
function cie10_url(){
  const url = new URL("{% url 'tu_app:cie10_listar' %}", window.location.origin);
  const q = document.getElementById('cie10_q').value.trim();
  if(q) url.searchParams.set('q', q);
  return url.toString();
}
$(function(){
  cie10_dt = $('#cie10_tbl').DataTable({
    ajax: { url: cie10_url(), dataSrc: 'data.rows' },
    columns: [
      { data: 'id_cie10' }, { data: 'codigo' }, { data: 'descripcion' },
      { data: null, render: (r)=>`
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-primary" onclick="cie10_abrir({id:'${r.id_cie10}'})">Editar</button>
          <button class="btn btn-outline-danger" onclick="cie10_eliminar({id:'${r.id_cie10}'})">Eliminar</button>
        </div>` }
    ]
  });
});
function cie10_recargar(){ cie10_dt.ajax.url(cie10_url()).load(null, false); }
function cie10_abrir(p={}){
  const url = new URL("{% url 'tu_app:cie10_formulario' %}", window.location.origin);
  if(p.id) url.searchParams.set('id', p.id);
  fetch(url).then(r=>r.text()).then(html=>{
    document.getElementById('cie10_md_body').innerHTML = html;
    new bootstrap.Modal(document.getElementById('cie10_md')).show();
  });
}
function cie10_guardar(){
  const fd = new FormData(document.querySelector('#cie10_form'));
  fetch("{% url 'tu_app:cie10_guardar' %}", { method:'POST', body: fd })
    .then(r=>r.json()).then(j=>{
      if(j.ok){ bootstrap.Modal.getInstance(document.getElementById('cie10_md')).hide(); cie10_recargar(); appToast('Guardado'); }
      else appToast(j.message, true);
    }).catch(e=>appToast(e.toString(), true));
}
function cie10_eliminar(p){
  if(!confirm('¿Eliminar registro?')) return;
  const fd = new FormData(); fd.append('id', p.id);
  fetch("{% url 'tu_app:cie10_eliminar' %}", { method:'POST', body: fd })
    .then(r=>r.json()).then(j=>{
      if(j.ok){ cie10_recargar(); appToast('Eliminado'); }
      else appToast(j.message, true);
    }).catch(e=>appToast(e.toString(), true));
}
</script>
{% endblock %}
