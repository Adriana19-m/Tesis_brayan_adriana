{% extends "public/base_public.html" %}

{% block title %}Citas{% endblock %}

{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Citas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <style>
        #calendar_citas {
            max-width: 100%;
            margin: 0 auto 1rem auto;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            height: 650px;
        }
        .fc-toolbar { padding: .5rem; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Gestión de Citas</h4>
                        {% if is_admin or is_doctor %}
                        <button class="btn btn-primary" onclick="abrirFormulario()">
                            <i class="fas fa-plus"></i> Nueva Cita
                        </button>
                        {% elif is_paciente %}
                        <button class="btn btn-outline-primary" onclick="abrirFormularioPaciente()">Agendar nueva cita</button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <!-- Select para elegir doctor, visible para todos -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="filtro_doctor" class="form-label">Selecciona Doctor:</label>
                                <select id="filtro_doctor" class="form-select">
                                    <option value="">Todos los doctores</option>
                                    {% for doctor in doctores %}
                                    <option value="{{ doctor.id }}">{{ doctor.first_name }} {{ doctor.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <!-- Calendario principal -->
                        <div id="calendar_citas"></div>
                        
                        <!-- Solo admin/doctores ven listado de citas -->
                        {% if is_admin or is_doctor %}
                        <hr>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="filtro_estado" class="form-label">Filtrar por Estado:</label>
                                <select id="filtro_estado" class="form-select" onchange="cargarCitas()">
                                    <option value="">Todos los estados</option>
                                    <option value="PENDIENTE">PENDIENTE</option>
                                    <option value="CONFIRMADA">CONFIRMADA</option>
                                    <option value="ATENDIDA">ATENDIDA</option>
                                    <option value="CANCELADA">CANCELADA</option>
                                    <option value="NO_ASISTE">NO_ASISTE</option>
                                    <option value="REPROGRAMADA">REPROGRAMADA</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Paciente ID</th>
                                        <th>Doctor ID</th>
                                        <th>Fecha y Hora</th>
                                        <th>Tipo</th>
                                        <th>Estado</th>
                                        <th>Motivo</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-citas"></tbody>
                            </table>
                        </div>
                        {% endif %}
                        
                        {% if is_paciente %}
                        <div class="alert alert-info mt-4">Como paciente solo puede agendar citas usando el calendario. Seleccione el doctor y luego el horario disponible en el calendario.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para el formulario -->
    <div class="modal fade" id="modalFormulario" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">Nueva Cita</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="formulario-contenido"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>
    <script>
    const IS_PACIENTE = {% if is_paciente %}true{% else %}false{% endif %};
    const IS_ADMIN = {% if is_admin %}true{% else %}false{% endif %};
    const IS_DOCTOR = {% if is_doctor %}true{% else %}false{% endif %};
    const CURRENT_USER_ID = {% if user_id %}{{ user_id }}{% else %}null{% endif %};
    </script>
    <script>
        let modalFormulario = new bootstrap.Modal(document.getElementById('modalFormulario'));

        $(document).ready(function() {
            inicializarCalendarioCitas();
            {% if is_admin or is_doctor %}
            cargarCitas();
            {% endif %}
        });

        function cargarCitas() {
            const estado = $('#filtro_estado').val();
            let url = '{% url "cita_listar" %}';
            if (estado) url += '?estado=' + encodeURIComponent(estado);
            $.ajax({
                url: url,
                type: 'GET',
                success: function(response) {
                    const tbody = $('#tabla-citas');
                    tbody.empty();
                    if (response.data && response.data.length > 0) {
                        response.data.forEach(function(cita) {
                            const fila = `
                                <tr>
                                    <td>${cita.id_cita}</td>
                                    <td>${cita.id_paciente}</td>
                                    <td>${cita.id_doctor}</td>
                                    <td>${cita.fecha_hora}</td>
                                    <td><span class="badge bg-info">${cita.tipo_cita}</span></td>
                                    <td><span class="badge bg-secondary">${cita.estado}</span></td>
                                    <td>${cita.motivo || ''}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="editarCita(${cita.id_cita})"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger" onclick="eliminarCita(${cita.id_cita})"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `;
                            tbody.append(fila);
                        });
                    } else {
                        tbody.append('<tr><td colspan="8" class="text-center">No se encontraron citas</td></tr>');
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error al cargar las citas');
                }
            });
        }

        function abrirFormulario() {
            $('#modalTitulo').text('Nueva Cita');
            $('#formulario-contenido').load('{% url "cita_formulario" %}', function() {
                modalFormulario.show();
                configurarFormulario();
            });
        }
        function editarCita(id) {
            $('#modalTitulo').text('Editar Cita');
            $('#formulario-contenido').load('{% url "cita_formulario" %}?id=' + id, function() {
                modalFormulario.show();
                configurarFormulario();
            });
        }
        function configurarFormulario() {
            $('#cita_form').on('submit', function(e) {
                e.preventDefault();
                guardarCita();
            });
        }
        function guardarCita() {
            const formData = new FormData(document.getElementById('cita_form'));
            $.ajax({
                url: '{% url "cita_guardar" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.message === 'Guardado') {
                        modalFormulario.hide();
                        if (IS_ADMIN || IS_DOCTOR) cargarCitas();
                        calendarCitas.refetchEvents();
                        alert('Cita guardada correctamente');
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr) {
                    alert('Error al guardar la cita');
                }
            });
        }
        function eliminarCita(id) {
            if (confirm('¿Estás seguro de que quieres eliminar esta cita?')) {
                const formData = new FormData();
                formData.append('id', id);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                $.ajax({
                    url: '{% url "cita_eliminar" %}',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.message === 'Eliminado') {
                            if (IS_ADMIN || IS_DOCTOR) cargarCitas();
                            calendarCitas.refetchEvents();
                            alert('Cita eliminada correctamente');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        alert('Error al eliminar la cita');
                    }
                });
            }
        }

        // Calendario principal
        let calendarCitas;
        function inicializarCalendarioCitas() {
            const el = document.getElementById('calendar_citas');
            if (!el) return;
            // Solo desde hoy en adelante
            const today = new Date().toISOString().slice(0,10);
            calendarCitas = new FullCalendar.Calendar(el, {
                locale: 'es',
                initialView: 'dayGridMonth',
                initialDate: today,
                validRange: { start: today },
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                selectable: IS_ADMIN || IS_DOCTOR || IS_PACIENTE,
                // Opcional: si usas timeGridDay/week y quieres limitar hora
                slotMinTime: '08:00:00',
                slotMaxTime: '18:00:00',
                events: function(fetchInfo, successCallback, failureCallback) {
                    // Obtener doctor del select
                    const doctorId = $('#filtro_doctor').val();
                    let url = '{% url "horario_disponibilidad" %}';
                    const params = [];
                    if (doctorId) params.push('doctor_id=' + doctorId);
                    params.push('start=' + encodeURIComponent(fetchInfo.startStr));
                    params.push('end=' + encodeURIComponent(fetchInfo.endStr));
                    params.push('slot_minutes=30');
                    if (params.length) url += '?' + params.join('&');
                    $.ajax({
                        url: url,
                        type: 'GET',
                        success: function(events) {
                            successCallback(events);
                        },
                        error: function() {
                            failureCallback();
                        }
                    });
                },
                eventClick: function(info) {
                    const event = info.event;
                    if (event.extendedProps.tipo === 'disponible') {
                        // Al hacer clic en slot disponible, abre formulario
                        $('#formulario-contenido').load('{% url "cita_formulario" %}', function() {
                            $('#id_doctor').val(event.extendedProps.doctor_id);
                            const dt = new Date(event.start);
                            const local = new Date(dt.getTime() - (dt.getTimezoneOffset() * 60000));
                            $('#fecha_hora').val(local.toISOString().slice(0,16));
                            $('#id_paciente').val(CURRENT_USER_ID);
                            modalFormulario.show();
                            configurarFormulario();
                        });
                    } else if (event.extendedProps.tipo === 'cita') {
                        if (IS_ADMIN || IS_DOCTOR) {
                            editarCita(event.extendedProps.cita_id);
                        }
                    }
                }
            });
            calendarCitas.render();

            // Recargar calendario al cambiar doctor
            $('#filtro_doctor').on('change', function() {
                calendarCitas.refetchEvents();
            });
        }

        function abrirFormularioPaciente() {
            alert("Seleccione un horario disponible en el calendario para agendar su cita.");
        }
    </script>
</body>
</html>
{% endblock %}