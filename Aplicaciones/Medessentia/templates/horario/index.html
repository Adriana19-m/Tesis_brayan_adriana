{% extends "dashboards/base_dashboard.html" %}

{% block title %}Horarios Doctor{% endblock %}

{% block content %}
{% load static %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Gestión de Horarios Doctor</h4>
                    <div>
                        <a href="{% url 'horario_calendario' %}" class="btn btn-info me-2">
                            <i class="fas fa-calendar-alt"></i> Ver Calendario
                        </a>
                        <button class="btn btn-primary" onclick="abrirFormulario()">
                            <i class="fas fa-plus"></i> Nuevo Horario
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="filtro_doctor" class="form-label">Filtrar por Doctor:</label>
                            <select id="filtro_doctor" class="form-select" onchange="cargarHorarios()">
                                <option value="">Todos los doctores</option>
                                {% for doctor in doctores %}
                                <option value="{{ doctor.id }}">{{ doctor.first_name }} {{ doctor.last_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Tabla de horarios -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Doctor</th>
                                    <th>Día Semana</th>
                                    <th>Hora Inicio</th>
                                    <th>Hora Fin</th>
                                    <th>Duración</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-horarios">
                                <!-- Los datos se cargan via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para el formulario -->
<div class="modal fade" id="modalFormulario" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitulo">Nuevo Horario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- El formulario se carga aquí via AJAX -->
                <div id="formulario-contenido"></div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts: jQuery, Bootstrap (asegúrate de tenerlos cargados en el base si ya lo haces) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const modalFormulario = new bootstrap.Modal(document.getElementById('modalFormulario'));

    // CSRF setup para AJAX
    $.ajaxSetup({
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    });

    $(document).ready(function() {
        cargarHorarios();
    });

    function cargarHorarios() {
        const doctorId = $('#filtro_doctor').val();
        let url = '{% url "horario_listar" %}';
        if (doctorId) url += '?doctor_id=' + encodeURIComponent(doctorId);

        $.getJSON(url)
            .done(function(response) {
                const tbody = $('#tabla-horarios');
                tbody.empty();

                if (response.data && response.data.length > 0) {
                    response.data.forEach(function(horario) {
                        // Calcular duración
                        const inicio = parseTime(horario.hora_inicio);
                        const fin = parseTime(horario.hora_fin);
                        const diffMs = fin - inicio;
                        const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                        const duracion = diffHrs > 0 ?
                            `${diffHrs}h ${diffMins > 0 ? diffMins + 'm' : ''}`.trim() :
                            `${diffMins}m`;

                        const acciones = ({% if is_admin or is_doctor %} true {% else %} false {% endif %}) ? `
                            <button class="btn btn-sm btn-warning" onclick="editarHorario(${horario.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarHorario(${horario.id})">
                                <i class="fas fa-trash"></i>
                            </button>` : '';

                        const fila = `
                            <tr>
                                <td>${horario.id}</td>
                                <td>${horario.doctor_nombre}</td>
                                <td><span class="badge bg-primary">${horario.dia_semana}</span></td>
                                <td>${horario.hora_inicio}</td>
                                <td>${horario.hora_fin}</td>
                                <td>${duracion}</td>
                                <td>${acciones}</td>
                            </tr>
                        `;
                        tbody.append(fila);
                    });
                } else {
                    tbody.append('<tr><td colspan="7" class="text-center">No se encontraron horarios</td></tr>');
                }
            })
            .fail(function(xhr) {
                console.error('Error al cargar horarios:', xhr);
                alert('Error al cargar los horarios');
            });
    }

    function parseTime(hhmm) {
        // hh:mm -> Date object base en día fijo
        const parts = hhmm.split(':');
        const d = new Date(2000,0,1, parseInt(parts[0],10), parseInt(parts[1],10));
        return d;
    }

    function abrirFormulario() {
        $('#modalTitulo').text('Nuevo Horario');
        $('#formulario-contenido').load('{% url "horario_formulario" %}', function(response, status, xhr) {
            if (status === "error") {
                alert('Error al cargar el formulario');
                return;
            }
            modalFormulario.show();
            configurarFormulario();
        });
    }

    function editarHorario(id) {
        $('#modalTitulo').text('Editar Horario');
        $('#formulario-contenido').load('{% url "horario_formulario" %}?id=' + id, function(response, status, xhr) {
            if (status === "error") {
                alert('Error al cargar el formulario de edición');
                return;
            }
            modalFormulario.show();
            configurarFormulario();
        });
    }

    function configurarFormulario() {
        // Delegación por si el formulario se recarga
        $('#horario_form').off('submit').on('submit', function(e) {
            e.preventDefault();
            guardarHorario();
        });
    }

    function guardarHorario() {
        const $form = $('#horario_form');
        const url = $form.attr('action') || '{% url "horario_guardar" %}';
        const data = $form.serialize();

        $.post(url, data)
            .done(function(response) {
                if (response.success) {
                    modalFormulario.hide();
                    cargarHorarios();
                    alert(response.message || 'Horario guardado correctamente');
                } else {
                    // mostrar errores de validación
                    mostrarErroresFormulario(response.errors || {});
                    alert(response.message || 'Error al guardar');
                }
            })
            .fail(function(xhr) {
                console.error('Error al guardar horario', xhr);
                alert('Error al guardar el horario');
            });
    }

    function mostrarErroresFormulario(errors) {
        // limpiar errores previos
        $('#horario_form .is-invalid').removeClass('is-invalid');
        $('#horario_form .invalid-feedback').remove();
        for (const [field, msgs] of Object.entries(errors)) {
            const $field = $(`#id_${field}`);
            if ($field.length) {
                $field.addClass('is-invalid');
                const feedback = $('<div class="invalid-feedback"></div>').text(msgs.join(' '));
                $field.after(feedback);
            }
        }
    }

    function eliminarHorario(id) {
        if (!confirm('¿Estás seguro de que quieres eliminar este horario?')) return;

        $.post('{% url "horario_eliminar" %}', { id: id })
            .done(function(response) {
                if (response.success) {
                    cargarHorarios();
                    alert(response.message || 'Horario eliminado correctamente');
                } else {
                    alert(response.message || 'No se pudo eliminar');
                }
            })
            .fail(function(xhr) {
                console.error('Error al eliminar', xhr);
                alert('Error al eliminar el horario');
            });
    }
</script>
{% endblock %}